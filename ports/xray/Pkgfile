version="1.5.0"
geo_version="202111082210"
desc="The best v2ray-core, with XTLS support"
makedeps=['go']
source=[
	{name="xray-${version}.tar.gz", url="https://github.com/XTLS/Xray-core/archive/v${version}.tar.gz"},
	{name="geosite-${geo_version}.dat", url="https://github.com/Loyalsoldier/v2ray-rules-dat/releases/download/${geo_version}/geosite.dat"},
	{name="geoip-${geo_version}.dat", url="https://github.com/Loyalsoldier/v2ray-rules-dat/releases/download/${geo_version}/geoip.dat"},
	{url="xray.sysusers"},
	{url="xray.tmpfiles"},
	{url="xray.service"},
	{url="xray@.service"},
]

build='''
	install -Dm 644 "geoip-${geo_version}.dat" "${pkgdir}"/share/xray/geoip.dat
	install -Dm 644 "geosite-${geo_version}.dat" "${pkgdir}"/share/xray/geosite.dat

	cd "Xray-core-${version}"
	export GOFLAGS="-buildmode=pie -trimpath -ldflags=-linkmode=external"
	export CGO_LDFLAGS="${LDFLAGS}"
	export CGO_CFLAGS="${CFLAGS}"
	export CGO_CPPFLAGS="${CPPFLAGS}"
	go build -o xray ./main
	install -d "${pkgdir}"/etc/xray/
	install -Dm 755 xray -t "${pkgdir}"/bin/
	install -Dm 644 "${srcdir}"/xray.sysusers "${pkgdir}"/lib/sysusers.d/xray.conf
	install -Dm 644 "${srcdir}"/xray.tmpfiles "${pkgdir}"/lib/tmpfiles.d/xray.conf
	install -Dm 644 "${srcdir}"/xray.service -t "${pkgdir}"/lib/systemd/system/
	install -Dm 644 "${srcdir}"/xray@.service -t "${pkgdir}"/lib/systemd/system/
'''
